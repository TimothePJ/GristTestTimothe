<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Grist Two-Step Selection with Editable Table</title>
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background-color: #2c2c2c;
      color: white;
    }

    .sticky-container {
      position: sticky;
      top: 0;
      background-color: #2c2c2c;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      z-index: 1000;
      box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
    }

    label {
      font-weight: bold;
      margin-bottom: 10px;
    }

    select {
      width: 200px;
      padding: 8px;
      margin-bottom: 20px;
    }

    table {
      width: 100%;
      max-width: 800px;
      border-collapse: collapse;
      margin-top: 20px;
      background-color: #fff;
    }

    th, td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: left;
    }

    th {
      background-color: #333;
      color: white;
    }

    td {
      color: black;
    }

    .table-container {
      margin-top: 20px;
      padding: 20px;
    }
  </style>
</head>
<body>
  <!-- Container for the sticky selection lists -->
  <div class="sticky-container">
    <!-- First dropdown for selecting a project -->
    <label for="firstColumnDropdown">Projet :</label>
    <select id="firstColumnDropdown">
      <option value="">Sélectionnez un projet</option>
    </select>

    <!-- Second listbox for selecting the tableau -->
    <label for="secondColumnListbox">Tableau :</label>
    <select id="secondColumnListbox" multiple size="10"></select>
  </div>

  <!-- Table to display and edit the data -->
  <div class="table-container">
    <table id="dataTable">
      <thead>
        <tr id="tableHeader">
          <th>ID</th> <!-- Add a column for ID -->
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <script>
    const apiKey = '52a7601b8532a91257c92a42eda896b47aa6c73d';
    const docId = 'h7kNsaQWiWzdVBU8WfZWpF';
    const tableId = 'Fusion';
    const gristBaseUrl = `https://vincitest.getgrist.com/api/docs/${docId}/tables/${tableId}/records`;
    let records = [];
    let selectedFirstValue = '';
    let selectedSecondValue = '';

    // Ready Grist
    grist.ready();

    // Function to fetch records from Grist and populate dropdowns
    async function fetchRecords() {
      try {
        const response = await fetch(gristBaseUrl, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          }
        });

        if (!response.ok) {
          throw new Error(`Erreur: ${response.statusText}`);
        }

        const data = await response.json();
        records = data.records.map(record => ({
          NomProjet: record.fields.NomProjet || '',
          NomEtage: record.fields.NomEtage || '',
          Emetteur: record.fields.Emetteur || '',
          Reference: record.fields.Reference || '',
          Indice: record.fields.Indice || '',
          Recu: record.fields.Recu || '',
          DescriptionObservations: record.fields.DescriptionObservations || '',
          ID_Ligne: record.id
        }));

        populateFirstColumnDropdown([...new Set(records.map(record => record.NomProjet))]);
      } catch (error) {
        console.error("Erreur lors de la récupération des enregistrements:", error);
      }
    }

    // Populate the first dropdown with unique project values
    function populateFirstColumnDropdown(values) {
      const dropdown = document.getElementById('firstColumnDropdown');
      dropdown.innerHTML = '<option value="">Sélectionnez un projet</option>';

      values.forEach(value => {
        if (value) {
          const option = document.createElement('option');
          option.value = value;
          option.text = value;
          dropdown.appendChild(option);
        }
      });
    }

    // Populate the second listbox (floor) based on the selected project
    function populateSecondColumnListbox(selectedValue) {
      const listbox = document.getElementById('secondColumnListbox');
      listbox.innerHTML = '';

      const floorValues = records
        .filter(record => record.NomProjet === selectedValue)
        .map(record => record.NomEtage)
        .filter((value, index, self) => value && self.indexOf(value) === index)
        .sort();

      floorValues.forEach(value => {
        const option = document.createElement('option');
        option.value = value;
        option.text = value;
        listbox.appendChild(option);
      });
    }

    // Populate table based on selected project and floor
    function populateTable() {
      const tableHeader = document.getElementById('tableHeader');
      const tableBody = document.getElementById('tableBody');

      // Clear the table
      tableBody.innerHTML = '';

      const filteredRecords = records
        .filter(record => record.NomProjet === selectedFirstValue && record.NomEtage === selectedSecondValue);

      if (filteredRecords.length === 0) return;

      const headers = Object.keys(filteredRecords[0]).filter(key => key !== 'NomProjet' && key !== 'NomEtage' && key !== 'ID_Ligne');
      tableHeader.innerHTML = '<th>ID</th>';
      headers.forEach(header => {
        const th = document.createElement('th');
        th.textContent = header;
        tableHeader.appendChild(th);
      });

      filteredRecords.forEach(record => {
        const tr = document.createElement('tr');

        const idCell = document.createElement('td');
        idCell.textContent = record.ID_Ligne;
        tr.appendChild(idCell);

        headers.forEach(header => {
          const td = document.createElement('td');
          td.contentEditable = true;
          td.textContent = record[header] || '';
          tr.appendChild(td);
        });

        tableBody.appendChild(tr);
      });
    }

    // Event listeners for dropdown changes
    document.getElementById('firstColumnDropdown').addEventListener('change', function() {
      selectedFirstValue = this.value;
      if (selectedFirstValue) {
        populateSecondColumnListbox(selectedFirstValue);
      } else {
        document.getElementById('secondColumnListbox').innerHTML = '';
      }
    });

    document.getElementById('secondColumnListbox').addEventListener('change', function() {
      selectedSecondValue = this.value;
      if (selectedFirstValue && selectedSecondValue) {
        populateTable();
      }
    });

    // Initial data fetch
    fetchRecords();
  </script>
</body>
</html>
