<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Grist Two-Step Selection with Editable Table</title>
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
        background-color: #2c2c2c;
        color: white;
      }

      .sticky-container {
        position: sticky;
        top: 0;
        background-color: #2c2c2c;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        z-index: 1000;
        box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
      }

      label {
        font-weight: bold;
        margin-bottom: 10px;
      }

      select {
        width: 200px;
        padding: 8px;
        margin-bottom: 20px;
      }

      table {
        width: 100%;
        max-width: 800px;
        border-collapse: collapse;
        margin-top: 100px;
        background-color: #fff;
      }

      th, td {
        padding: 10px;
        border: 1px solid #ddd;
        text-align: left;
      }

      th {
        background-color: #333;
        color: white;
      }

      td {
        color: black;
      }

      .table-container {
        margin-top: 20px;
        padding: 20px;
      }

      .add-form {
        margin-top: 20px;
        padding: 10px;
        background-color: #f4f4f4;
        color: black;
      }

      .add-form input {
        margin-right: 10px;
        padding: 5px;
      }

      .add-form button {
        padding: 5px 10px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <!-- Container for the sticky selection lists -->
    <div class="sticky-container">
      <!-- First dropdown for selecting a project -->
      <label for="firstColumnDropdown">Projet :</label>
      <select id="firstColumnDropdown">
        <option value="">Select an option</option>
      </select>

      <!-- Second listbox for selecting the tableau -->
      <label for="secondColumnListbox">Tableau :</label>
      <select id="secondColumnListbox" multiple size="10"></select>
    </div>

    <!-- Table to display and edit the data -->
    <div class="table-container">
      <table id="dataTable">
        <thead>
          <tr id="tableHeader"></tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <!-- Form to add new rows -->
    <div class="add-form">
      <h3>Ajouter une nouvelle ligne :</h3>
      <input type="text" id="emetteurInput" placeholder="Emetteur">
      <input type="text" id="referenceInput" placeholder="Référence">
      <input type="text" id="indiceInput" placeholder="Indice">
      <input type="text" id="recuInput" placeholder="Reçu">
      <input type="text" id="descriptionInput" placeholder="Description/Observations">
      <button id="addRowButton">Ajouter</button>
    </div>

    <script>
      let records = [];
      let selectedFirstValue = '';
      let selectedSecondValue = '';

      // Ready Grist
      grist.ready();

      // Function to add a new row (empty) to Grist when button is clicked
      document.getElementById('addRowButton').addEventListener('click', function() {
        // Step 1: Add an empty record to Grist to obtain the new row's ID
        grist.docApi.applyUserActions([['AddRecord', 'Fusion', {}]])  // 'Fusion' is your table name
        .then((response) => {
          const newID_Ligne = response[0];  // Grist returns the new row ID
          console.log("New empty row added with ID:", newID_Ligne);

          // Step 2: Create a new record with input values and the new ID_Ligne
          const newRecord = {
            NomProjet: selectedFirstValue,  // Value from the first selection list
            NomEtage: selectedSecondValue,  // Value from the second selection list
            Emetteur: document.getElementById('emetteurInput').value,
            Reference: document.getElementById('referenceInput').value,
            Indice: document.getElementById('indiceInput').value,
            Recu: document.getElementById('recuInput').value,
            DescriptionObservations: document.getElementById('descriptionInput').value,
            ID_Ligne: newID_Ligne // Use the new ID from Grist
          };

          // Step 3: Update the newly created record in Grist with the user inputs
          updateRecordInGrist(newRecord);

          // Add new record to the list and refresh the table
          records.push(newRecord);
          populateTable();

          // Clear input fields
          document.getElementById('emetteurInput').value = '';
          document.getElementById('referenceInput').value = '';
          document.getElementById('indiceInput').value = '';
          document.getElementById('recuInput').value = '';
          document.getElementById('descriptionInput').value = '';
        }).catch(error => {
          console.error("Failed to add record to Grist:", error);
        });
      });

      // Function to update a record in Grist
      function updateRecordInGrist(record) {
        grist.docApi.applyUserActions([['UpdateRecord', 'Fusion', record.ID_Ligne, record]])  // 'Fusion' is your table name
        .then(() => {
          console.log("Record updated in Grist:", record);
        }).catch(error => {
          console.error("Failed to update record in Grist:", error);
        });
      }

      // Populate first dropdown
      function populateFirstColumnDropdown(values) {
        const dropdown = document.getElementById('firstColumnDropdown');
        dropdown.innerHTML = '<option value="">Select an option</option>';  // Reset the dropdown
        values.forEach(value => {
          if (value) {  // Skip null or empty values
            const option = document.createElement('option');
            option.value = value;
            option.text = value;
            dropdown.appendChild(option);
          }
        });
      }

      // Listen to changes in the first dropdown and update the second listbox accordingly
      document.getElementById('firstColumnDropdown').addEventListener('change', function() {
        selectedFirstValue = this.value;
        if (selectedFirstValue) {
          populateSecondColumnListbox(selectedFirstValue);
        } else {
          document.getElementById('secondColumnListbox').innerHTML = '';  // Clear second listbox if no selection
        }
      });

      // Listen to changes in the second listbox and update the table accordingly
      document.getElementById('secondColumnListbox').addEventListener('change', function() {
        selectedSecondValue = this.value;
        if (selectedFirstValue && selectedSecondValue) {
          populateTable();
        }
      });

      // Function to populate the second listbox based on the selected first column value
      function populateSecondColumnListbox(selectedValue) {
        const listbox = document.getElementById('secondColumnListbox');
        listbox.innerHTML = '';  // Clear current listbox
        const secondColumnValues = records
          .filter(record => record.NomProjet === selectedValue)
          .map(record => record.NomEtage)
          .filter((value, index, self) => value && self.indexOf(value) === index)
          .sort();
        secondColumnValues.forEach(value => {
          const option = document.createElement('option');
          option.value = value;
          option.text = value;
          listbox.appendChild(option);
        });
      }

      // Fetch records from Grist
      grist.onRecords(function(receivedRecords) {
        console.log("Records received from Grist:", receivedRecords); // Debugging output
        records = receivedRecords.map(record => ({
          NomProjet: record.NomProjet || '',
          NomEtage: record.NomEtage || '',
          Emetteur: record.Emetteur || '',
          Reference: record.Reference || '',
          Indice: record.Indice || '',
          Recu: record.Recu || '',
          DescriptionObservations: record.DescriptionObservations || '',
          ID_Ligne: record.ID_Ligne || '' // Exclude this column from the table display
        }));
        const uniqueFirstColumnValues = [...new Set(records.map(record => record.NomProjet))];
        populateFirstColumnDropdown(uniqueFirstColumnValues);
      });
    </script>
  </body>
</html>
