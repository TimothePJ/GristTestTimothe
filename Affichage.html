<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Grist Two-Step Selection with Contextual Menu</title>
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
        background-color: #2c2c2c;
        color: white;
      }

      .sticky-container {
        position: sticky;
        top: 0;
        background-color: #2c2c2c;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        z-index: 1000;
        box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
      }

      label {
        font-weight: bold;
        margin-bottom: 10px;
      }

      select {
        width: 200px;
        padding: 8px;
        margin-bottom: 20px;
      }

      table {
        width: 100%;
        max-width: 800px;
        border-collapse: collapse;
        margin-top: 100px;
        background-color: #fff;
      }

      th, td {
        padding: 10px;
        border: 1px solid #ddd;
        text-align: left;
      }

      th {
        background-color: #333;
        color: white;
      }

      td {
        color: black;
      }

      .table-container {
        margin-top: 20px;
        padding: 20px;
      }

      /* Context menu styling */
      .context-menu {
        position: absolute;
        background-color: #333;
        border: 1px solid #ddd;
        padding: 5px;
        display: none;
        z-index: 1000;
        color: white;
        cursor: pointer;
      }

      .context-menu div {
        padding: 8px;
        border-bottom: 1px solid #ddd;
      }

      .context-menu div:hover {
        background-color: #444;
      }

      .context-menu div:last-child {
        border-bottom: none;
      }
    </style>
  </head>
  <body>
    <!-- Container for the sticky selection lists -->
    <div class="sticky-container">
      <!-- First dropdown for selecting a project -->
      <label for="firstColumnDropdown">Projet :</label>
      <select id="firstColumnDropdown">
        <option value="">Select an option</option>
      </select>

      <!-- Second listbox for selecting the tableau -->
      <label for="secondColumnListbox">Tableau :</label>
      <select id="secondColumnListbox" multiple size="10"></select>
    </div>

    <!-- Table to display and edit the data -->
    <div class="table-container">
      <table id="dataTable">
        <thead>
          <tr id="tableHeader"></tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <!-- Context menu for row actions -->
    <div id="contextMenu" class="context-menu">
      <div id="addRowAbove">Ajouter une ligne au-dessus</div>
      <div id="addRowBelow">Ajouter une ligne en dessous</div>
      <div id="deleteRow">Supprimer la ligne</div>
    </div>

    <script>
      let records = [];
      let selectedFirstValue = '';
      let selectedSecondValue = '';
      let selectedRowRecord = null; // To track the selected row for adding/deleting
      let selectedRowIndex = null;  // To track the selected row index for inserting rows

      // Function to populate the first dropdown with unique values from the first column
      function populateFirstColumnDropdown(values) {
        const dropdown = document.getElementById('firstColumnDropdown');
        dropdown.innerHTML = '<option value="">Select an option</option>';  // Reset the dropdown

        values.forEach(value => {
          if (value) {  // Skip null or empty values
            const option = document.createElement('option');
            option.value = value;
            option.text = value;
            dropdown.appendChild(option);
          }
        });
        console.log("First column populated:", values); // Debugging output
      }

      // Function to populate the second listbox based on the selected first column value
      function populateSecondColumnListbox(selectedValue) {
        const listbox = document.getElementById('secondColumnListbox');
        listbox.innerHTML = '';  // Clear current listbox

        const secondColumnValues = records
          .filter(record => record.NomProjet === selectedValue)  // Filter based on selected first column value
          .map(record => record.NomEtage)  // Extract second column values
          .filter((value, index, self) => value && self.indexOf(value) === index)  // Remove duplicates and null/empty values
          .sort();

        secondColumnValues.forEach(value => {
          const option = document.createElement('option');
          option.value = value;
          option.text = value;
          listbox.appendChild(option);
        });

        console.log("Second column values populated for", selectedValue, ":", secondColumnValues); // Debugging output
      }

      // Function to populate the table based on the selected first and second column values
      function populateTable() {
        const tableHeader = document.getElementById('tableHeader');
        const tableBody = document.getElementById('tableBody');

        // Clear the table
        tableHeader.innerHTML = '';
        tableBody.innerHTML = '';

        const filteredRecords = records
          .filter(record => record.NomProjet === selectedFirstValue && record.NomEtage === selectedSecondValue);

        if (filteredRecords.length === 0) return;

        const exampleRecord = filteredRecords[0];
        const headers = Object.keys(exampleRecord).filter(key => key !== 'NomProjet' && key !== 'NomEtage' && key !== 'ID_Ligne'); // Skip first two and last column (ID_Ligne)

        // Populate the table header
        headers.forEach(header => {
          const th = document.createElement('th');
          th.textContent = header;
          tableHeader.appendChild(th);
        });

        // Populate the table body with filtered records
        filteredRecords.forEach((record, rowIndex) => {
          const tr = document.createElement('tr');
          headers.forEach(header => {
            const td = document.createElement('td');
            td.contentEditable = "true";  // Make cells editable
            td.textContent = record[header] || '';  // Use empty string for null/undefined values
            td.addEventListener('blur', function() {
              record[header] = td.textContent; // Update record with edited value
            });
            tr.appendChild(td);
          });

          // Add event listener for right-click to show context menu
          tr.addEventListener('contextmenu', function(event) {
            event.preventDefault();
            selectedRowRecord = { record, rowIndex };  // Track the selected row and index
            selectedRowIndex = rowIndex;  // Store row index for adding rows above/below
            showContextMenu(event.pageX, event.pageY); // Show the context menu at the click position
          });

          tableBody.appendChild(tr);
        });

        console.log("Table populated with records:", filteredRecords); // Debugging output
      }

      // Function to show the context menu
      function showContextMenu(x, y) {
        const contextMenu = document.getElementById('contextMenu');
        contextMenu.style.display = 'block';
        contextMenu.style.left = `${x}px`;
        contextMenu.style.top = `${y}px`;
      }

      // Function to hide the context menu
      function hideContextMenu() {
        const contextMenu = document.getElementById('contextMenu');
        contextMenu.style.display = 'none';
      }

      // Handle deleting a row from the context menu
      document.getElementById('deleteRow').addEventListener('click', function() {
        if (selectedRowRecord) {
          // Remove the record both locally and in Grist
          deleteRecordFromGrist(selectedRowRecord.record);
          records.splice(records.indexOf(selectedRowRecord.record), 1); // Remove from local records
          populateTable(); // Refresh the table
        }
        hideContextMenu(); // Hide the context menu after deleting
      });

      // Handle adding a new row above the selected row from the context menu
      document.getElementById('addRowAbove').addEventListener('click', function() {
        if (selectedRowRecord) {
          const newRecord = createNewRecord();
          records.splice(selectedRowIndex, 0, newRecord); // Insert exactly above the selected row
          addRecordToGrist(newRecord);
          populateTable(); // Refresh the table
        }
        hideContextMenu(); // Hide the context menu after adding
      });

      // Handle adding a new row below the selected row from the context menu
      document.getElementById('addRowBelow').addEventListener('click', function() {
        if (selectedRowRecord) {
          const newRecord = createNewRecord();
          records.splice(selectedRowIndex + 1, 0, newRecord); // Insert exactly below the selected row
          addRecordToGrist(newRecord);
          populateTable(); // Refresh the table
        }
        hideContextMenu(); // Hide the context menu after adding
      });

      // Function to create a new blank record (you can modify default values here)
      function createNewRecord() {
        return {
          NomProjet: selectedFirstValue,
          NomEtage: selectedSecondValue,
          Emetteur: '',
          Reference: '',
          Indice: '',
          Recu: '',
          DescriptionObservations: '',
          ID_Ligne: records.length + 1 // Temporary ID for new rows, change logic if necessary
        };
      }

      // Hide the context menu when clicking outside
      document.addEventListener('click', function(event) {
        const contextMenu = document.getElementById('contextMenu');
        if (!contextMenu.contains(event.target)) {
          hideContextMenu();
        }
      });

      // Ready Grist
      grist.ready();

      // Fetch records from Grist
      grist.onRecords(function(receivedRecords) {
        console.log("Records received from Grist:", receivedRecords); // Debugging output
        
        records = receivedRecords.map(record => {
          const nomProjet = record.NomProjet || null;
          const nomEtage = record.NomEtage || null;

          // Include other columns in the record
          return {
            NomProjet: nomProjet,
            NomEtage: nomEtage,
            Emetteur: record.Emetteur || '',
            Reference: record.Reference || '',
            Indice: record.Indice || '',
            Recu: record.Recu || '',
            DescriptionObservations: record.DescriptionObservations || '',
            ID_Ligne: record.ID_Ligne || '' // Exclude this column from the table display
          };
        });

        // Populate the first dropdown with unique values from 'NomProjet'
        const uniqueFirstColumnValues = [...new Set(records.map(record => record.NomProjet))];
        populateFirstColumnDropdown(uniqueFirstColumnValues);
      });

      // Listen to changes in the first dropdown and update the second listbox accordingly
      document.getElementById('firstColumnDropdown').addEventListener('change', function() {
        selectedFirstValue = this.value;
        if (selectedFirstValue) {
          populateSecondColumnListbox(selectedFirstValue);
        } else {
          document.getElementById('secondColumnListbox').innerHTML = '';  // Clear second listbox if no selection
        }
      });

      // Listen to changes in the second listbox and update the table accordingly
      document.getElementById('secondColumnListbox').addEventListener('change', function() {
        selectedSecondValue = this.value;
        if (selectedFirstValue && selectedSecondValue) {
          populateTable();
        }
      });

      // Function to add a record to Grist via the API
      function addRecordToGrist(record) {
        grist.docApi.applyUserActions([
          ['AddRecord', 'Fusion', record] // Replace 'Fusion' with your table ID if necessary
        ]).then(() => {
          console.log("Record added to Grist:", record);
        }).catch(error => {
          console.error("Failed to add record to Grist:", error);
        });
      }

      // Function to delete a record from Grist
      function deleteRecordFromGrist(record) {
        grist.docApi.applyUserActions([
          ['RemoveRecord', 'Fusion', record.ID_Ligne] // Use ID_Ligne to delete the correct record
        ]).then(() => {
          console.log("Record deleted from Grist:", record);
        }).catch(error => {
          console.error("Failed to delete record from Grist:", error);
        });
      }
    </script>
  </body>
</html>
