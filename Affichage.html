<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Grist Two-Step Selection</title>
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  </head>
  <body>
    <label for="firstColumnDropdown">Select from first column (NomProjet):</label>
    <select id="firstColumnDropdown">
      <option value="">Select an option</option>
    </select>

    <br><br>

    <label for="secondColumnListbox">Second column values (NomEtage):</label>
    <select id="secondColumnListbox" multiple size="10">
    </select>

    <script>
      let records = [];

      // Function to populate the first dropdown with unique values from the first column
      function populateFirstColumnDropdown(values) {
        const dropdown = document.getElementById('firstColumnDropdown');
        dropdown.innerHTML = '<option value="">Select an option</option>';  // Reset the dropdown

        values.forEach(value => {
          const option = document.createElement('option');
          option.value = value;
          option.text = value;
          dropdown.appendChild(option);
        });
        console.log("First column populated:", values); // Debugging output
      }

      // Function to populate the second listbox based on the selected first column value
      function populateSecondColumnListbox(selectedValue) {
        const listbox = document.getElementById('secondColumnListbox');
        listbox.innerHTML = '';  // Clear current listbox

        const secondColumnValues = records
          .filter(record => record.NomProjet === selectedValue)  // Filter based on selected first column value
          .map(record => record.NomEtage)  // Extract second column values
          .filter((value, index, self) => self.indexOf(value) === index)  // Remove duplicates
          .sort();

        secondColumnValues.forEach(value => {
          const option = document.createElement('option');
          option.value = value;
          option.text = value;
          listbox.appendChild(option);
        });

        console.log("Second column values populated for", selectedValue, ":", secondColumnValues); // Debugging output
      }

      // Ready Grist
      grist.ready();

      // Fetch records from Grist
      grist.onRecords(function(receivedRecords) {
        console.log("Records received from Grist:", receivedRecords); // Debugging output
        
        records = receivedRecords.map(record => {
          const nomProjet = record.NomProjet || null;
          const nomEtage = record.NomEtage || null;

          console.log("Record:", record); // Log each record for debugging
          console.log("NomProjet:", nomProjet, "NomEtage:", nomEtage); // Debugging output for specific fields

          return {
            NomProjet: nomProjet,
            NomEtage: nomEtage
          };
        });

        // Populate the first dropdown with unique values from 'NomProjet'
        const uniqueFirstColumnValues = [...new Set(records.map(record => record.NomProjet))];
        populateFirstColumnDropdown(uniqueFirstColumnValues);
      });

      // Listen to changes in the first dropdown and update the second listbox accordingly
      document.getElementById('firstColumnDropdown').addEventListener('change', function() {
        const selectedValue = this.value;
        if (selectedValue) {
          populateSecondColumnListbox(selectedValue);
        } else {
          document.getElementById('secondColumnListbox').innerHTML = '';  // Clear second listbox if no selection
        }
      });
    </script>
  </body>
</html>
