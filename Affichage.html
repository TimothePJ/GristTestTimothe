async function saveChanges() {
  // Récupération explicite des valeurs sélectionnées dans les listes déroulantes
  const projectDropdown = document.getElementById('firstColumnDropdown');
  const tableDropdown = document.getElementById('secondColumnListbox');
  
  const currentProject = projectDropdown.value;
  const currentTable = tableDropdown.value;

  if (!currentProject || !currentTable) {
    alert("Veuillez sélectionner un projet et un tableau avant de sauvegarder.");
    return;
  }

  console.log(`Sauvegarde en cours pour le tableau "${currentTable}" du projet "${currentProject}".`);

  // Récupération des lignes du tableau HTML
  const tableBody = document.getElementById('tableBody');
  const rows = tableBody.getElementsByTagName('tr');

  // Map des noms de colonnes dans Grist pour correspondre aux colonnes du tableau HTML
  const columnMap = ['Emetteur', 'Reference', 'Indice', 'Recu', 'DescriptionObservations'];

  const updates = [];

  for (const row of rows) {
    const cells = row.getElementsByTagName('td');
    const rowId = cells[0].textContent.trim(); // ID_Ligne de la ligne dans le tableau HTML (première cellule)

    // Vérifie que la ligne appartient au projet et au tableau actuels
    const record = records.find(rec => rec.ID_Ligne === rowId && 
                                       rec.NomProjet === currentProject &&
                                       rec.NomEtage === currentTable);

    if (!record) {
      console.warn(`Aucune correspondance pour ID_Ligne = ${rowId} dans le tableau "${currentTable}" du projet "${currentProject}".`);
      continue;
    }

    const updatedFields = {};
    let hasChanges = false;

    // Parcours des cellules du tableau HTML pour comparer avec l'enregistrement
    for (let i = 1; i < cells.length; i++) {
      const fieldName = columnMap[i - 1];
      const cellValue = cells[i].textContent.trim();

      if (record[fieldName] !== cellValue) {
        console.log(`Modification détectée pour ID_Ligne = ${rowId} - Champ : ${fieldName}, Ancienne : "${record[fieldName]}", Nouvelle : "${cellValue}"`);
        updatedFields[fieldName] = cellValue;
        hasChanges = true;
      }
    }

    if (hasChanges) {
      updates.push(['UpdateRecord', 'Fusion', Number(rowId), updatedFields]);
    }
  }

  // Applique les modifications si des changements sont détectés
  if (updates.length > 0) {
    try {
      await grist.docApi.applyUserActions(updates);
      console.log("Modifications sauvegardées avec succès :", updates);
      alert("Les modifications ont été sauvegardées.");
    } catch (error) {
      console.error("Erreur lors de la sauvegarde des modifications :", error);
      alert("Erreur lors de la sauvegarde des modifications.");
    }
  } else {
    alert("Aucune modification détectée pour sauvegarde.");
  }
}
