<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Grist Two-Step Selection with Editable Table</title>
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
        background-color: #2c2c2c;
        color: white;
      }

      .sticky-container {
        position: sticky;
        top: 0;
        background-color: #2c2c2c;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        z-index: 1000;
        box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
      }

      label {
        font-weight: bold;
        margin-bottom: 10px;
      }

      select {
        width: 200px;
        padding: 8px;
        margin-bottom: 20px;
      }

      table {
        width: 100%;
        max-width: 800px;
        border-collapse: collapse;
        margin-top: 20px;
        background-color: #fff;
      }

      th, td {
        padding: 10px;
        border: 1px solid #ddd;
        text-align: left;
      }

      th {
        background-color: #333;
        color: white;
      }

      td {
        color: black;
      }

      .table-container {
        margin-top: 20px;
        padding: 20px;
      }

      .add-form {
        margin-top: 20px;
        padding: 10px;
        background-color: #f4f4f4;
        color: black;
      }

      .add-form input {
        margin-right: 10px;
        padding: 5px;
      }

      .add-form button {
        padding: 5px 10px;
        cursor: pointer;
      }

      /* Context Menu Styles */
      .context-menu {
        display: none;
        position: absolute;
        background-color: #333;
        color: white;
        border: 1px solid #ddd;
        z-index: 10000;
        padding: 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      }

      .context-menu button {
        display: block;
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        padding: 5px;
        width: 100%;
        text-align: left;
      }

      .context-menu button:hover {
        background-color: #444;
      }
    </style>
  </head>
  <body>
    <!-- Container for the sticky selection lists -->
    <div class="sticky-container">
      <!-- First dropdown for selecting a project -->
      <label for="firstColumnDropdown">Projet :</label>
      <select id="firstColumnDropdown">
        <option value="">Select an option</option>
      </select>

      <!-- Second listbox for selecting the tableau -->
      <label for="secondColumnListbox">Tableau :</label>
      <select id="secondColumnListbox" multiple size="10"></select>
    </div>

    <!-- Table to display and edit the data -->
    <div class="table-container">
      <table id="dataTable">
        <thead>
          <tr id="tableHeader">
            <th>ID</th> <!-- Add a column for ID -->
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <!-- Context Menu -->
    <div id="contextMenu" class="context-menu">
      <button id="deleteOption">Supprimer</button>
    </div>

    <!-- Form to add new rows -->
    <div class="add-form">
      <h3>Ajouter une nouvelle ligne :</h3>
      <input type="text" id="emetteurInput" placeholder="Emetteur">
      <input type="text" id="referenceInput" placeholder="Référence">
      <input type="text" id="indiceInput" placeholder="Indice">
      <input type="text" id="recuInput" placeholder="Reçu">
      <input type="text" id="descriptionInput" placeholder="Description/Observations">
      <button id="addRowButton">Ajouter</button>
    </div>

    <script>
      const apiKey = '52a7601b8532a91257c92a42eda896b47aa6c73d'; // Utiliser votre clé API
      const docId = 'h7kNsaQWiWzdVBU8WfZWpF'; // Remplacer par l'ID de votre document Grist
      const tableId = 'Fusion'; // Nom de la table où ajouter les enregistrements
      const gristBaseUrl = `https://vincitest.getgrist.com/api/docs/${docId}/tables/${tableId}/records`;

      // Fonction pour ajouter une nouvelle ligne via l'API
      document.getElementById('addRowButton').addEventListener('click', async () => {
        const emetteur = document.getElementById('emetteurInput').value;
        const reference = document.getElementById('referenceInput').value;
        const indice = document.getElementById('indiceInput').value;
        const recu = document.getElementById('recuInput').value;
        const description = document.getElementById('descriptionInput').value;

        // Créer un objet pour la nouvelle ligne
        const newRow = {
          fields: {
            NomProjet: selectedFirstValue || '',
            NomEtage: selectedSecondValue || '',
            Emetteur: emetteur || '',
            Reference: reference || '',
            Indice: indice || '',
            Recu: recu || '',
            DescriptionObservations: description || ''
          }
        };

        try {
          // Appel à l'API Grist pour ajouter la nouvelle ligne
          const response = await fetch(gristBaseUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({ records: [newRow] })
          });

          if (!response.ok) {
            throw new Error(`Erreur: ${response.statusText}`);
          }

          const result = await response.json();
          const newRecordId = result.records[0].id; // Récupérer l'ID du nouvel enregistrement

          // Mettre à jour les données locales et réafficher la table
          records.push({ ...newRow.fields, ID_Ligne: newRecordId });
          populateTable();

          // Vider les champs du formulaire
          document.getElementById('emetteurInput').value = '';
          document.getElementById('referenceInput').value = '';
          document.getElementById('indiceInput').value = '';
          document.getElementById('recuInput').value = '';
          document.getElementById('descriptionInput').value = '';

          console.log("Nouvelle ligne ajoutée avec succès:", result);
        } catch (error) {
          console.error("Erreur lors de l'ajout de la nouvelle ligne:", error);
        }
      });

      function populateTable() {
        const tableHeader = document.getElementById('tableHeader');
        const tableBody = document.getElementById('tableBody');

        // Clear the table
        tableBody.innerHTML = '';

        const filteredRecords = records
          .filter(record => record.NomProjet === selectedFirstValue && record.NomEtage === selectedSecondValue);

        if (filteredRecords.length === 0) return;

        const exampleRecord = filteredRecords[0];
        const headers = Object.keys(exampleRecord).filter(key => key !== 'NomProjet' && key !== 'NomEtage' && key !== 'ID_Ligne'); // Skip first two and last column (ID_Ligne)

        // Populate the table header with the additional 'ID' column
        tableHeader.innerHTML = '<th>ID</th>';
        headers.forEach(header => {
          const th = document.createElement('th');
          th.textContent = header;
          tableHeader.appendChild(th);
        });

        // Populate the table body with filtered records
        filteredRecords.forEach((record, rowIndex) => {
          const tr = document.createElement('tr');
          tr.addEventListener('contextmenu', (event) => showContextMenu(event, record.ID_Ligne)); // Show context menu on right-click and store the ID

          // Add the ID as the first column
          const idCell = document.createElement('td');
          idCell.textContent = record.ID_Ligne;
          tr.appendChild(idCell);

          headers.forEach(header => {
            const td = document.createElement('td');
            td.contentEditable = "true";  // Make cells editable
            td.textContent = record[header] || '';  // Use empty string for null/undefined values
            td.addEventListener('blur', function() {
              record[header] = td.textContent; // Update record with edited value
              updateRecordInGrist(record); // Save changes to Grist
            });
            tr.appendChild(td);
          });

          tableBody.appendChild(tr);
        });
      }

    </script>
  </body>
</html>
